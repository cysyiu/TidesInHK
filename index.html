<!DOCTYPE html>
<html>
<head>
  <title>Tide Stations Map</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 600px; }
    /* Constrain the popup table's width and allow horizontal scrolling */
    .popup-table-container {
      max-width: 400px;
      overflow-x: auto;
    }
    .popup-table-container table {
      width: 100%;
      border-collapse: collapse;
    }
    .popup-table-container th,
    .popup-table-container td {
      border: 1px solid #ccc;
      padding: 4px;
      text-align: center;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Include Leaflet JS library -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- Include Papa Parse library for CSV parsing -->
  <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
  <script>
    // Initialize the map centered over Hong Kong
    var map = L.map('map').setView([22.3, 114.2], 11);

    // Add OpenStreetMap tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Load the GeoJSON file containing tide station markers.
    fetch('tide_stations.geojson')
      .then(response => response.json())
      .then(data => {
        L.geoJSON(data, {
          onEachFeature: function (feature, layer) {
            // Bind a basic popup prompting user to click to load tide data.
            layer.bindPopup("<strong>" + feature.properties.TideStation_en + "</strong><br/>Click for tide data");
            
            // When marker is clicked, fetch the CSV data.
            layer.on('click', function() {
              var csvUrl = feature.properties.Data_url;
              fetch(csvUrl)
                .then(response => response.text())
                .then(csvText => {
                  // Parse the CSV content with header row.
                  var results = Papa.parse(csvText, {header: true});
                  // Define which columns to show in the popup.
                  var keysToShow = [
                    "Tide Station", 
                    "Datetime (Year)", 
                    "Datetime (Month)", 
                    "Datetime (Day)", 
                    "Datetime (Hour)", 
                    "Datetime (Minute)", 
                    "Height(m)"
                  ];
                  
                  // Build a simplified table.
                  var html = "<div class='popup-table-container'><strong>" 
                      + feature.properties.TideStation_en 
                      + " Tide Data:</strong><br/><table><tr>";
                  // Add table headers.
                  keysToShow.forEach(function(key) {
                    html += "<th>" + key + "</th>";
                  });
                  html += "</tr>";
                  
                  // Show only the first 3 rows for brevity.
                  results.data.slice(0, 3).forEach(function(row) {
                    html += "<tr>";
                    keysToShow.forEach(function(key) {
                      html += "<td>" + (row[key] || "") + "</td>";
                    });
                    html += "</tr>";
                  });
                  html += "</table><br/><em>Showing first 3 rows.</em></div>";
                  // Update the popup content.
                  layer.getPopup().setContent(html).openOn(map);
                })
                .catch(err => {
                  console.error("Error loading CSV: ", err);
                  layer.getPopup().setContent("Error loading CSV data.").openOn(map);
                });
            });
          }
        }).addTo(map);
      })
      .catch(err => console.error("Error loading GeoJSON: ", err));
  </script>
</body>
</html>
